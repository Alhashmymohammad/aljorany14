<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#4f46e5">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Aljorany</title>
<link rel="manifest" href="manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--p1:#4f46e5;--p2:#7c3aed;--p3:#2563eb;--grad:linear-gradient(135deg,#4f46e5 0%,#7c3aed 50%,#2563eb 100%);--bg:#f5f3ff;--bg2:#ede9fe;--surface:#ffffff;--surface2:#f8f7ff;--text:#1e1b4b;--text2:#5b5b8a;--text3:#9ca3af;--border:rgba(99,102,241,0.15);--border2:rgba(99,102,241,0.3);--shadow:0 4px 20px rgba(79,70,229,0.12);--ok:#10b981;--r:18px;--r2:12px;}
[data-theme="dark"]{--bg:#0d0b1e;--bg2:#13103a;--surface:#1a1740;--surface2:#1e1b4b;--text:#e8e5ff;--text2:#a5b4fc;--text3:#6b7280;--border:rgba(99,102,241,0.2);--border2:rgba(99,102,241,0.4);--shadow:0 4px 20px rgba(0,0,0,0.4);}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow-x:hidden}
body{font-family:'Cairo',sans-serif;background:var(--bg);color:var(--text);transition:background .3s,color .3s;min-height:100vh;min-height:-webkit-fill-available}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 60% 50% at 20% 10%,rgba(99,102,241,.07) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 80%,rgba(124,58,237,.06) 0%,transparent 70%)}
.header{background:var(--grad);padding:env(safe-area-inset-top,0) 0 0;position:sticky;top:0;z-index:100;box-shadow:0 4px 30px rgba(79,70,229,0.4)}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:14px 18px}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:40px;height:40px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;border:1px solid rgba(255,255,255,0.3)}
.logo-text{font-size:22px;font-weight:900;color:#fff;letter-spacing:1px}
.logo-sub{font-size:10px;color:rgba(255,255,255,0.75);font-weight:600}
.icon-btn{width:38px;height:38px;border-radius:10px;border:1.5px solid rgba(255,255,255,0.35);background:rgba(255,255,255,0.15);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.icon-btn:active{transform:scale(.92)}
.scroll-area{height:calc(100vh - 68px);overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;position:relative;z-index:1}
.scroll-area::-webkit-scrollbar{width:0}
.content{padding:16px 14px 80px;max-width:600px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
.card{background:var(--surface);border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;transition:all .3s}
.card-head{padding:14px 16px 10px;display:flex;align-items:center;gap:8px}
.card-icon{width:30px;height:30px;border-radius:8px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0}
.card-title{font-size:13px;font-weight:700;color:var(--text2);letter-spacing:.5px}
.card-body{padding:0 14px 14px}
#fileInput{display:none}
.import-zone{border:2px dashed var(--border2);border-radius:var(--r2);padding:22px 16px;text-align:center;cursor:pointer;background:var(--surface2);transition:all .25s}
.import-zone:active{background:rgba(79,70,229,.08)}
.import-icon{font-size:36px;margin-bottom:8px;display:block}
.import-text{font-size:15px;font-weight:700;color:var(--p1);margin-bottom:4px}
.import-hint{font-size:11px;color:var(--text3);line-height:1.5}
.file-info{display:none;margin-top:10px;padding:12px;background:var(--surface2);border-radius:var(--r2);border:1px solid var(--border);gap:10px;align-items:center}
.file-info.show{display:flex}
.file-icon-wrap{font-size:28px;flex-shrink:0}
.file-details{flex:1;min-width:0}
.file-name{font-size:13px;font-weight:700;color:var(--text);word-break:break-all;line-height:1.3}
.file-meta{font-size:11px;color:var(--text3);margin-top:3px}
.status-pill{font-size:11px;font-weight:700;padding:4px 12px;border-radius:20px;white-space:nowrap;flex-shrink:0;background:var(--grad);color:#fff}
.prog-wrap{display:none;margin-top:12px}
.prog-wrap.show{display:block}
.prog-labels{display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px}
.prog-track{height:8px;background:var(--bg2);border-radius:8px;overflow:hidden}
.prog-bar{height:100%;border-radius:8px;background:var(--grad);background-size:200% 100%;animation:gs 1.8s linear infinite;transition:width .4s cubic-bezier(.4,0,.2,1);width:0%}
@keyframes gs{0%{background-position:0% 50%}100%{background-position:200% 50%}}
.stats-row{display:none;grid-template-columns:repeat(3,1fr);gap:10px}
.stats-row.show{display:grid}
.stat-card{background:var(--surface);border-radius:var(--r2);border:1px solid var(--border);padding:12px 8px;text-align:center;box-shadow:0 2px 8px rgba(79,70,229,0.08)}
.stat-value{font-size:20px;font-weight:900;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.2}
.stat-label{font-size:10px;color:var(--text3);font-weight:600;margin-top:3px}
.search-wrap{display:flex;gap:8px;align-items:stretch}
.search-input{flex:1;padding:14px 16px;border-radius:var(--r2);border:2px solid var(--border);background:var(--surface2);color:var(--text);font-size:15px;font-family:'Cairo',sans-serif;font-weight:600;outline:none;transition:all .25s;direction:rtl;min-width:0}
.search-input:focus{border-color:var(--p1);background:var(--surface);box-shadow:0 0 0 4px rgba(79,70,229,.12)}
.search-input::placeholder{color:var(--text3);font-weight:400}
.search-btn{width:52px;border-radius:var(--r2);border:none;background:var(--grad);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;box-shadow:var(--shadow)}
.search-btn:active{transform:scale(.93)}
.search-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.mode-row{display:flex;align-items:center;justify-content:center;gap:6px;margin-top:10px;font-size:11px;color:var(--text3)}
.mode-pill{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;background:rgba(79,70,229,.12);color:var(--p1);font-size:11px;font-weight:700}
.filter-toggle{width:100%;margin-top:10px;padding:10px 14px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--p1);font-size:13px;font-weight:700;font-family:'Cairo',sans-serif;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s}
.filter-toggle:active{background:var(--surface2)}
.filter-panel{display:none;flex-direction:column;gap:14px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.filter-panel.show{display:flex}
.filter-sec-title{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.chips-wrap{display:flex;flex-wrap:wrap;gap:7px}
.chip{padding:7px 14px;border-radius:20px;border:1.5px solid var(--border2);background:var(--surface2);color:var(--text2);font-size:12px;font-weight:700;font-family:'Cairo',sans-serif;cursor:pointer;transition:all .2s;white-space:nowrap}
.chip.active{background:var(--grad);color:#fff;border-color:transparent;box-shadow:0 3px 12px rgba(79,70,229,.3)}
.chip:active{transform:scale(.95)}
.mode-desc{padding:9px 12px;border-radius:10px;background:var(--surface2);border:1px solid var(--border);font-size:11px;color:var(--text2);line-height:1.7;margin-top:8px}
.res-header{padding:14px 16px 10px;display:flex;align-items:center;justify-content:space-between}
.res-title{font-size:14px;font-weight:800;display:flex;align-items:center;gap:8px}
.cnt-pill{background:var(--grad);color:#fff;font-size:11px;font-weight:700;padding:3px 12px;border-radius:20px}
.copy-all-btn{padding:7px 14px;border-radius:9px;border:none;background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff;font-size:12px;font-weight:700;font-family:'Cairo',sans-serif;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.copy-all-btn:active{transform:scale(.95)}
.res-list{padding:0 12px 12px;display:flex;flex-direction:column;gap:10px}
.res-item{background:var(--surface2);border:1.5px solid var(--border);border-right:4px solid var(--p1);border-radius:14px;padding:13px 13px 13px 46px;position:relative;animation:fu .25s ease both}
@keyframes fu{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.res-name{font-size:17px;font-weight:800;color:var(--text);line-height:1.5;margin-bottom:8px}
.res-name mark{background:linear-gradient(135deg,rgba(79,70,229,.2),rgba(124,58,237,.2));color:var(--p1);border-radius:4px;padding:0 3px;font-weight:900;font-style:normal}
.res-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:10px}
.rtag{font-size:10px;padding:2px 9px;border-radius:20px;background:rgba(79,70,229,.1);color:var(--p2);font-weight:700}
.row-cells{display:flex;flex-wrap:wrap;gap:5px;padding-top:9px;border-top:1px dashed var(--border2)}
.cell{padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600;border:1px solid var(--border);background:var(--surface);color:var(--text);word-break:break-word;max-width:100%;line-height:1.5}
.cell.matched{background:linear-gradient(135deg,rgba(79,70,229,.15),rgba(124,58,237,.15));border-color:var(--p1);color:var(--p1);font-weight:700}
.copy-btn{position:absolute;top:12px;left:12px;width:30px;height:30px;border-radius:8px;border:none;background:rgba(79,70,229,.1);color:var(--p1);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.copy-btn:active{transform:scale(.9)}
.copy-btn.done{background:var(--ok);color:#fff}
.empty-state{text-align:center;padding:50px 20px;color:var(--text3)}
.empty-emoji{font-size:52px;margin-bottom:14px}
.empty-text{font-size:14px;line-height:1.8;color:var(--text2)}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:#1e1b4b;color:#fff;padding:11px 24px;border-radius:30px;font-size:13px;font-family:'Cairo',sans-serif;font-weight:700;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.4);transition:transform .35s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}
</style>
</head>
<body data-theme="light">

<div class="header">
  <div class="header-inner">
    <div class="logo">
      <div class="logo-icon">ğŸ”</div>
      <div>
        <div class="logo-text">Aljorany</div>
        <div class="logo-sub">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Excel</div>
      </div>
    </div>
    <button class="icon-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
  </div>
</div>

<div class="scroll-area">
<div class="content">

  <div class="card">
    <div class="card-head">
      <div class="card-icon">ğŸ“‚</div>
      <div class="card-title">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel</div>
    </div>
    <div class="card-body">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv" onchange="loadFile(this)">
      <div class="import-zone" onclick="document.getElementById('fileInput').click()">
        <span class="import-icon">ğŸ“Š</span>
        <div class="import-text">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù</div>
        <div class="import-hint">xlsx Â· xls Â· xlsm Â· xlsb Â· xltx Â· xltm Â· ods Â· csv</div>
      </div>
      <div class="file-info" id="fileInfo">
        <div class="file-icon-wrap">ğŸ“—</div>
        <div class="file-details">
          <div class="file-name" id="fName">â€”</div>
          <div class="file-meta" id="fMeta">â€”</div>
        </div>
        <div class="status-pill" id="fStatus">Ø¬Ø§Ø±ÙŠ</div>
      </div>
      <div class="prog-wrap" id="progWrap">
        <div class="prog-labels"><span id="progLbl">Ø¬Ø§Ø±ÙŠ...</span><span id="progPct">0%</span></div>
        <div class="prog-track"><div class="prog-bar" id="progBar"></div></div>
      </div>
    </div>
  </div>

  <div class="stats-row" id="statsRow">
    <div class="stat-card"><div class="stat-value" id="sRows">0</div><div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ</div></div>
    <div class="stat-card"><div class="stat-value" id="sSheets">0</div><div class="stat-label">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</div></div>
    <div class="stat-card"><div class="stat-value" id="sRes">â€”</div><div class="stat-label">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div></div>
  </div>

  <div class="card">
    <div class="card-head">
      <div class="card-icon">ğŸ”</div>
      <div class="card-title">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>
    </div>
    <div class="card-body">
      <div class="search-wrap">
        <input class="search-input" id="searchInput" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù„Ø«..." oninput="onInput()" onkeydown="if(event.key==='Enter')doSearch()">
        <button class="search-btn" id="searchBtn" onclick="doSearch()" disabled>ğŸ”</button>
      </div>
      <div class="mode-row">ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø«: <span class="mode-pill" id="modePill">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚</span></div>
      <div class="filter-panel" id="filterPanel">
        <div>
          <div class="filter-sec-title">âš™ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø«</div>
          <div class="chips-wrap">
            <button class="chip active" id="modeExact" onclick="setMode('exact')">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚</button>
            <button class="chip" id="modeAny" onclick="setMode('any')">ğŸ”„ Ø£ÙŠ ØªØ±ØªÙŠØ¨</button>
            <button class="chip" id="modeStart" onclick="setMode('start')">â–¶ï¸ ÙŠØ¨Ø¯Ø£ Ø¨Ù€</button>
          </div>
          <div class="mode-desc" id="modeDesc">ğŸ¯ <b>ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚:</b> ÙŠØ¨Ø­Ø« Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ â€” Ø§Ù„Ø£ÙˆÙ„ Ø«Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«ØŒ ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø®Ù„Ø§ÙŠØ§ Ù…ØªØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØµÙ</div>
        </div>
        <div>
          <div class="filter-sec-title">ğŸ“„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ±Ù‚Ø©</div>
          <div class="chips-wrap" id="sheetChips">
            <button class="chip active" onclick="selectSheet('__all__',this)">ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</button>
          </div>
        </div>
      </div>
      <button class="filter-toggle" onclick="toggleFilter()"><span id="fArrow">â–¼</span><span id="fTxt">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©</span></button>
    </div>
  </div>

  <div class="card" id="resCard" style="display:none">
    <div class="res-header">
      <div class="res-title">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ <span class="cnt-pill" id="cntPill">0</span></div>
      <button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="res-list" id="resList"></div>
  </div>

  <div class="card" id="emptyCard">
    <div class="empty-state">
      <div class="empty-emoji">ğŸ“Š</div>
      <div class="empty-text">Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù„Ù Excel<br>Ø«Ù… Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>
    </div>
  </div>

</div>
</div>

<div class="toast" id="toast"></div>

<script>
'use strict';
let SHEETS=[],TOTAL_ROWS=0,DARK=false,MODE='exact',ACTIVE_SHEET='__all__';

function toggleTheme(){DARK=!DARK;document.body.setAttribute('data-theme',DARK?'dark':'light');document.getElementById('themeBtn').textContent=DARK?'â˜€ï¸':'ğŸŒ™';}

let toastTimer;
function showToast(msg,ms=2600){clearTimeout(toastTimer);const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');toastTimer=setTimeout(()=>el.classList.remove('show'),ms);}

function fmtSize(b){if(b<1024)return b+' B';if(b<1048576)return (b/1024).toFixed(1)+' KB';return (b/1048576).toFixed(1)+' MB';}

function setProg(pct,lbl){document.getElementById('progBar').style.width=Math.min(pct,100)+'%';document.getElementById('progPct').textContent=Math.round(pct)+'%';if(lbl)document.getElementById('progLbl').textContent=lbl;}

const sleep=ms=>new Promise(r=>setTimeout(r,ms));

async function loadFile(input){
  const file=input.files[0];if(!file)return;
  SHEETS=[];TOTAL_ROWS=0;ACTIVE_SHEET='__all__';
  document.getElementById('resCard').style.display='none';
  document.getElementById('emptyCard').style.display='block';
  document.getElementById('statsRow').classList.remove('show');
  document.getElementById('searchBtn').disabled=true;
  document.getElementById('sRes').textContent='â€”';
  document.getElementById('fileInfo').classList.add('show');
  document.getElementById('fName').textContent=file.name;
  document.getElementById('fMeta').textContent=fmtSize(file.size)+' â€¢ '+new Date(file.lastModified).toLocaleDateString('ar-SA');
  document.getElementById('fStatus').textContent='ÙŠÙØ­Ù…ÙÙ‘Ù„';
  document.getElementById('progWrap').classList.add('show');
  setProg(5,'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...');
  const reader=new FileReader();
  reader.onprogress=e=>{if(e.lengthComputable)setProg((e.loaded/e.total)*40,'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');};
  reader.onload=async e=>{
    try{
      setProg(45,'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');await sleep(40);
      const raw=new Uint8Array(e.target.result);
      setProg(55,'ÙØªØ­ Ø§Ù„Ù…ØµÙ†Ù...');await sleep(40);
      let wb;
      try{wb=XLSX.read(raw,{type:'array',cellText:true,cellDates:true});}
      catch(_){wb=XLSX.read(new TextDecoder('utf-8',{fatal:false}).decode(raw),{type:'string'});}
      const names=wb.SheetNames;
      setProg(65,'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚...');await sleep(40);
      for(let i=0;i<names.length;i++){
        const ws=wb.Sheets[names[i]];
        const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:false});
        const rows=[];
        for(const row of json){
          if(row.some(c=>c!==null&&c!==undefined&&String(c).trim()!=='')){
            rows.push(row.map(c=>c!==null&&c!==undefined?String(c).trim():''));
            TOTAL_ROWS++;
          }
        }
        SHEETS.push({name:names[i],rows});
        setProg(65+((i+1)/names.length)*30,'ÙˆØ±Ù‚Ø©: '+names[i]);
        await sleep(20);
      }
      setProg(100,'Ø§ÙƒØªÙ…Ù„ âœ…');
      document.getElementById('fStatus').textContent='âœ… Ø¬Ø§Ù‡Ø²';
      document.getElementById('sRows').textContent=TOTAL_ROWS.toLocaleString('ar');
      document.getElementById('sSheets').textContent=names.length.toLocaleString('ar');
      document.getElementById('statsRow').classList.add('show');
      document.getElementById('searchBtn').disabled=false;
      buildSheetChips(names);
      showToast('âœ… '+file.name+' â€” '+TOTAL_ROWS.toLocaleString('ar')+' ØµÙ');
      setTimeout(()=>document.getElementById('progWrap').classList.remove('show'),1000);
    }catch(err){
      console.error(err);
      document.getElementById('fStatus').textContent='âŒ Ø®Ø·Ø£';
      showToast('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù');
      document.getElementById('progWrap').classList.remove('show');
    }
  };
  reader.readAsArrayBuffer(file);
}

function buildSheetChips(names){
  const w=document.getElementById('sheetChips');
  w.innerHTML='<button class="chip active" onclick="selectSheet(\'__all__\',this)">ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</button>';
  names.forEach(n=>{const b=document.createElement('button');b.className='chip';b.textContent=n;b.onclick=()=>selectSheet(n,b);w.appendChild(b);});
}

function selectSheet(name,btn){
  ACTIVE_SHEET=name;
  document.querySelectorAll('#sheetChips .chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

let filterOpen=false;
function toggleFilter(){
  filterOpen=!filterOpen;
  document.getElementById('filterPanel').classList.toggle('show',filterOpen);
  document.getElementById('fArrow').textContent=filterOpen?'â–²':'â–¼';
  document.getElementById('fTxt').textContent=filterOpen?'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª':'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©';
}

const MODES={
  exact:{pill:'ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚',desc:'ğŸ¯ <b>ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚:</b> ÙŠØ¨Ø­Ø« Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ â€” Ø§Ù„Ø£ÙˆÙ„ Ø«Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«ØŒ ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø®Ù„Ø§ÙŠØ§ Ù…ØªØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØµÙ'},
  any:{pill:'ğŸ”„ Ø£ÙŠ ØªØ±ØªÙŠØ¨',desc:'ğŸ”„ <b>Ø£ÙŠ ØªØ±ØªÙŠØ¨:</b> ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙˆØ£ÙŠ ØªØ±ØªÙŠØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ'},
  start:{pill:'â–¶ï¸ ÙŠØ¨Ø¯Ø£ Ø¨Ù€',desc:'â–¶ï¸ <b>ÙŠØ¨Ø¯Ø£ Ø¨Ù€:</b> ÙŠØ¬Ù„Ø¨ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø«Ù… ØªØ­ØªÙˆÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ'}
};

function setMode(m){
  MODE=m;
  ['exact','any','start'].forEach(x=>document.getElementById('mode'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('active',x===m));
  document.getElementById('modePill').textContent=MODES[m].pill;
  document.getElementById('modeDesc').innerHTML=MODES[m].desc;
}

function onInput(){
  const v=document.getElementById('searchInput').value.trim();
  document.getElementById('searchBtn').disabled=SHEETS.length===0||v.length===0;
}

/* â”€â”€ ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ â”€â”€ */
function norm(t){
  return t
    .replace(/[Ø£Ø¥Ø¢Ø§]/g,'Ø§')
    .replace(/Ø©/g,'Ù‡')
    .replace(/Ù‰/g,'ÙŠ')
    .replace(/[\u064B-\u065F]/g,'')
    .replace(/\s+/g,' ')
    .trim()
    .toLowerCase();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function matchRow(qWords,row){
  const normRow=row.map(c=>norm(c));

  /* 1) Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ØªØ­ØªÙˆÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ */
  for(let ci=0;ci<row.length;ci++){
    const nc=normRow[ci];
    if(!nc)continue;
    if(matchCell(qWords,nc))return{matched:row[ci],ci};
  }

  /* 2) ÙƒÙ„Ù…Ø§Øª Ù…ÙˆØ²Ù‘Ø¹Ø© Ø¹Ù„Ù‰ Ø®Ù„Ø§ÙŠØ§ Ù…ØªØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ */
  if(MODE==='exact'||MODE==='start'){
    const nonEmpty=normRow.map((nc,i)=>({nc,i})).filter(x=>x.nc.length>0);
    for(let si=0;si<=nonEmpty.length-qWords.length;si++){
      let ok=true;
      for(let wi=0;wi<qWords.length;wi++){
        if(!nonEmpty[si+wi].nc.includes(qWords[wi])){ok=false;break;}
      }
      if(ok){
        const combined=nonEmpty.slice(si,si+qWords.length).map(x=>row[x.i]).join(' ');
        return{matched:combined,ci:nonEmpty[si].i};
      }
    }
  }

  /* 3) Ø£ÙŠ ØªØ±ØªÙŠØ¨ Ø¹Ø¨Ø± Ø£ÙŠ Ø®Ù„Ø§ÙŠØ§ */
  if(MODE==='any'){
    const nonEmpty=normRow.map((nc,i)=>({nc,i})).filter(x=>x.nc.length>0);
    const used=new Set();
    const idxs=[];
    for(const w of qWords){
      let found=false;
      for(const {nc,i} of nonEmpty){
        if(!used.has(i)&&nc.includes(w)){idxs.push(i);used.add(i);found=true;break;}
      }
      if(!found)return null;
    }
    return{matched:idxs.map(i=>row[i]).join(' '),ci:idxs[0]};
  }

  return null;
}

function matchCell(words,nc){
  if(MODE==='exact'){
    let pos=0;
    for(const w of words){const idx=nc.indexOf(w,pos);if(idx===-1)return false;pos=idx+w.length;}
    return true;
  }
  if(MODE==='any')return words.every(w=>nc.includes(w));
  if(MODE==='start')return nc.startsWith(words[0])&&words.slice(1).every(w=>nc.includes(w));
  return false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doSearch(){
  const raw=document.getElementById('searchInput').value.trim();
  if(!raw||SHEETS.length===0)return;
  const qWords=raw.split(/\s+/).filter(w=>w.length>0).map(norm);
  if(!qWords.length)return;
  const results=[];
  document.getElementById('emptyCard').style.display='none';
  document.getElementById('resCard').style.display='none';
  document.getElementById('progWrap').classList.add('show');
  setProg(0,'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...');
  await sleep(25);
  const targets=ACTIVE_SHEET==='__all__'?SHEETS:SHEETS.filter(s=>s.name===ACTIVE_SHEET);
  for(let si=0;si<targets.length;si++){
    for(const row of targets[si].rows){
      const res=matchRow(qWords,row);
      if(res)results.push({name:res.matched,sheet:targets[si].name,row});
    }
    setProg(((si+1)/targets.length)*100,'Ø¨Ø­Ø« ÙÙŠ: '+targets[si].name);
    await sleep(12);
  }
  setProg(100,'Ø§ÙƒØªÙ…Ù„ âœ…');
  setTimeout(()=>document.getElementById('progWrap').classList.remove('show'),700);
  document.getElementById('sRes').textContent=results.length.toLocaleString('ar');
  renderResults(results,raw.split(/\s+/).filter(w=>w.length>0));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderResults(results,qWords){
  const list=document.getElementById('resList');
  const card=document.getElementById('resCard');
  list.innerHTML='';
  document.getElementById('cntPill').textContent=results.length;
  card.style.display='block';
  if(!results.length){
    list.innerHTML='<div class="empty-state"><div class="empty-emoji">ğŸ”</div><div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬<br>Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø«</div></div>';
    return;
  }
  const nq=qWords.map(norm);
  results.forEach((r,i)=>{
    const cells=r.row.filter(c=>c&&c.trim()!=='');
    const copyText=cells.join(' | ');
    const cellsHtml=cells.map(c=>{
      const isHit=nq.some(w=>norm(c).includes(w));
      return '<span class="cell '+(isHit?'matched':'')+'">'+esc(c)+'</span>';
    }).join('');
    const div=document.createElement('div');
    div.className='res-item';
    div.style.animationDelay=(i*35)+'ms';
    div.dataset.copy=copyText;
    div.innerHTML=
      '<button class="copy-btn" onclick="copyItem(this,event)">ğŸ“‹</button>'+
      '<div class="res-name">'+hlName(r.name,qWords)+'</div>'+
      '<div class="res-tags">'+
        '<span class="rtag">ğŸ“„ '+esc(r.sheet)+'</span>'+
        '<span class="rtag"># '+(i+1)+'</span>'+
      '</div>'+
      '<div class="row-cells">'+cellsHtml+'</div>';
    list.appendChild(div);
  });
  setTimeout(()=>document.getElementById('resCard').scrollIntoView({behavior:'smooth',block:'start'}),100);
}

function hlName(text,words){
  let r=esc(text);
  words.forEach(w=>{
    if(!w)return;
    try{r=r.replace(new RegExp(escRe(esc(w)),'gi'),m=>'<mark>'+m+'</mark>');}catch(_){}
  });
  return r;
}
function escRe(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function esc(t){return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function copyItem(btn,e){
  e.stopPropagation();
  writeClip(btn.closest('.res-item').dataset.copy);
  btn.textContent='âœ…';btn.classList.add('done');
  setTimeout(()=>{btn.textContent='ğŸ“‹';btn.classList.remove('done');},2000);
}

function copyAll(){
  const items=[...document.querySelectorAll('.res-item')];
  writeClip(items.map((el,i)=>(i+1)+'. '+el.dataset.copy).join('\n\n'));
  showToast('âœ… ØªÙ… Ù†Ø³Ø® '+items.length+' Ù†ØªÙŠØ¬Ø©');
}

function writeClip(text){
  if(navigator.clipboard){navigator.clipboard.writeText(text).then(()=>showToast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!')).catch(()=>fbCopy(text));}
  else{fbCopy(text);}
}

function fbCopy(text){
  const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0;top:0;left:0';
  document.body.appendChild(ta);ta.focus();ta.select();
  try{document.execCommand('copy');showToast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!');}catch(_){showToast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®');}
  document.body.removeChild(ta);
}

if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));}
</script>
</body>
</html>
