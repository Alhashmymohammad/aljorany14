<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="theme-color" content="#4f46e5">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Aljorany</title>
<link rel="manifest" href="manifest.json">
<!-- XLSX_PLACEHOLDER -->
<style>
:root{--p1:#4f46e5;--p2:#7c3aed;--p3:#2563eb;--grad:linear-gradient(135deg,#4f46e5 0%,#7c3aed 50%,#2563eb 100%);--bg:#f5f3ff;--bg2:#ede9fe;--surface:#fff;--surface2:#f8f7ff;--text:#1e1b4b;--text2:#5b5b8a;--text3:#9ca3af;--border:rgba(99,102,241,.15);--border2:rgba(99,102,241,.3);--shadow:0 4px 20px rgba(79,70,229,.12);--ok:#10b981;--r:18px;--r2:12px;}
[data-theme="dark"]{--bg:#0d0b1e;--bg2:#13103a;--surface:#1a1740;--surface2:#1e1b4b;--text:#e8e5ff;--text2:#a5b4fc;--text3:#6b7280;--border:rgba(99,102,241,.2);--border2:rgba(99,102,241,.4);--shadow:0 4px 20px rgba(0,0,0,.4);}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text);transition:background .3s,color .3s;display:flex;flex-direction:column;height:100vh;height:100dvh;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;background:radial-gradient(ellipse 60% 50% at 20% 10%,rgba(99,102,241,.07) 0%,transparent 70%),radial-gradient(ellipse 50% 40% at 80% 80%,rgba(124,58,237,.06) 0%,transparent 70%);}
.hdr{background:var(--grad);padding:env(safe-area-inset-top,0) 0 0;flex-shrink:0;box-shadow:0 4px 30px rgba(79,70,229,.4);position:relative;z-index:10}
.hdr-in{display:flex;align-items:center;justify-content:space-between;padding:13px 16px}
.logo{display:flex;align-items:center;gap:10px}
.logo-ico{width:38px;height:38px;background:rgba(255,255,255,.2);border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:19px;border:1px solid rgba(255,255,255,.3)}
.logo-name{font-size:21px;font-weight:900;color:#fff;letter-spacing:1px}
.logo-sub{font-size:10px;color:rgba(255,255,255,.75);font-weight:600}
.ico-btn{width:38px;height:38px;border-radius:10px;border:1.5px solid rgba(255,255,255,.35);background:rgba(255,255,255,.15);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.ico-btn:active{transform:scale(.9)}
.scroll{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;position:relative;z-index:1}
.scroll::-webkit-scrollbar{width:0}
.content{padding:14px 13px 80px;max-width:600px;margin:0 auto;display:flex;flex-direction:column;gap:11px}
.card{background:var(--surface);border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);overflow:hidden;transition:all .3s}
.card-hd{padding:13px 15px 9px;display:flex;align-items:center;gap:8px}
.card-ico{width:29px;height:29px;border-radius:8px;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.card-ttl{font-size:12px;font-weight:700;color:var(--text2);letter-spacing:.5px}
.card-bd{padding:0 13px 13px}
#fileInput{display:none}
.imp-zone{border:2px dashed var(--border2);border-radius:var(--r2);padding:20px 14px;text-align:center;cursor:pointer;background:var(--surface2);transition:all .25s}
.imp-zone:active{background:rgba(79,70,229,.08)}
.imp-ico{font-size:34px;margin-bottom:7px;display:block}
.imp-txt{font-size:14px;font-weight:700;color:var(--p1);margin-bottom:3px}
.imp-hint{font-size:10px;color:var(--text3);line-height:1.5}
.finfo{display:none;margin-top:9px;padding:11px;background:var(--surface2);border-radius:var(--r2);border:1px solid var(--border);gap:9px;align-items:center}
.finfo.show{display:flex}
.f-ico{font-size:27px;flex-shrink:0}
.f-det{flex:1;min-width:0}
.f-nm{font-size:12px;font-weight:700;color:var(--text);word-break:break-all;line-height:1.3}
.f-mt{font-size:10px;color:var(--text3);margin-top:2px}
.st-pill{font-size:10px;font-weight:700;padding:3px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0;background:var(--grad);color:#fff}
.prog{display:none;margin-top:11px}
.prog.show{display:block}
.prog-lbs{display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:var(--text2);margin-bottom:5px}
.prog-tr{height:8px;background:var(--bg2);border-radius:8px;overflow:hidden}
.prog-br{height:100%;border-radius:8px;background:var(--grad);background-size:200% 100%;animation:gs 1.8s linear infinite;transition:width .4s cubic-bezier(.4,0,.2,1);width:0%}
@keyframes gs{0%{background-position:0% 50%}100%{background-position:200% 50%}}
.stats{display:none;grid-template-columns:repeat(3,1fr);gap:9px}
.stats.show{display:grid}
.stat{background:var(--surface);border-radius:var(--r2);border:1px solid var(--border);padding:11px 7px;text-align:center;box-shadow:0 2px 8px rgba(79,70,229,.08)}
.stat-v{font-size:19px;font-weight:900;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-l{font-size:10px;color:var(--text3);font-weight:600;margin-top:2px}
.srch-row{display:flex;gap:8px;align-items:stretch}
.srch-in{flex:1;padding:13px 15px;border-radius:var(--r2);border:2px solid var(--border);background:var(--surface2);color:var(--text);font-size:15px;font-weight:600;outline:none;transition:all .25s;direction:rtl;min-width:0;font-family:inherit}
.srch-in:focus{border-color:var(--p1);background:var(--surface);box-shadow:0 0 0 4px rgba(79,70,229,.12)}
.srch-in::placeholder{color:var(--text3);font-weight:400}
.srch-btn{width:50px;border-radius:var(--r2);border:none;background:var(--grad);color:#fff;font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;box-shadow:var(--shadow)}
.srch-btn:active{transform:scale(.93)}
.srch-btn:disabled{opacity:.4;cursor:not-allowed;transform:none}
.mode-row{display:flex;align-items:center;justify-content:center;gap:5px;margin-top:9px;font-size:11px;color:var(--text3)}
.mpill{padding:3px 10px;border-radius:20px;background:rgba(79,70,229,.12);color:var(--p1);font-size:11px;font-weight:700}
.ftog{width:100%;margin-top:9px;padding:9px 13px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--p1);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .2s}
.ftog:active{background:var(--surface2)}
.fpanel{display:none;flex-direction:column;gap:13px;margin-top:11px;padding-top:11px;border-top:1px solid var(--border)}
.fpanel.show{display:flex}
.fsec-ttl{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{padding:6px 13px;border-radius:20px;border:1.5px solid var(--border2);background:var(--surface2);color:var(--text2);font-size:11px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s;white-space:nowrap}
.chip.active{background:var(--grad);color:#fff;border-color:transparent;box-shadow:0 3px 12px rgba(79,70,229,.3)}
.chip:active{transform:scale(.95)}
.mdesc{padding:8px 11px;border-radius:9px;background:var(--surface2);border:1px solid var(--border);font-size:11px;color:var(--text2);line-height:1.7;margin-top:7px}
.res-hd{padding:13px 15px 9px;display:flex;align-items:center;justify-content:space-between}
.res-ttl{font-size:13px;font-weight:800;display:flex;align-items:center;gap:7px}
.cnt-pill{background:var(--grad);color:#fff;font-size:11px;font-weight:700;padding:3px 11px;border-radius:20px}
.copy-all{padding:6px 13px;border-radius:8px;border:none;background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff;font-size:11px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .2s}
.copy-all:active{transform:scale(.95)}
.res-list{padding:0 11px 11px;display:flex;flex-direction:column;gap:9px}
.ritem{background:var(--surface2);border:1.5px solid var(--border);border-right:4px solid var(--p1);border-radius:13px;padding:12px 12px 12px 44px;position:relative;animation:fu .22s ease both}
@keyframes fu{from{opacity:0;transform:translateY(-7px)}to{opacity:1;transform:translateY(0)}}
.rname{font-size:16px;font-weight:800;color:var(--text);line-height:1.5;margin-bottom:7px}
.rname mark{background:linear-gradient(135deg,rgba(79,70,229,.2),rgba(124,58,237,.2));color:var(--p1);border-radius:4px;padding:0 3px;font-weight:900;font-style:normal}
.rtags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:9px}
.rtag{font-size:10px;padding:2px 8px;border-radius:20px;background:rgba(79,70,229,.1);color:var(--p2);font-weight:700}
.rcells{display:flex;flex-wrap:wrap;gap:4px;padding-top:8px;border-top:1px dashed var(--border2)}
.cell{padding:3px 9px;border-radius:7px;font-size:11px;font-weight:600;border:1px solid var(--border);background:var(--surface);color:var(--text);word-break:break-word;line-height:1.5}
.cell.hit{background:linear-gradient(135deg,rgba(79,70,229,.15),rgba(124,58,237,.15));border-color:var(--p1);color:var(--p1);font-weight:700}
.cbtn{position:absolute;top:11px;left:11px;width:29px;height:29px;border-radius:7px;border:none;background:rgba(79,70,229,.1);color:var(--p1);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.cbtn:active{transform:scale(.9)}
.cbtn.done{background:var(--ok);color:#fff}
.empty{text-align:center;padding:45px 18px}
.e-ico{font-size:50px;margin-bottom:12px}
.e-txt{font-size:13px;line-height:1.8;color:var(--text2)}
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(100px);background:#1e1b4b;color:#fff;padding:10px 22px;border-radius:30px;font-size:12px;font-weight:700;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.4);transition:transform .35s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}
.no-lib{display:none;margin:20px 13px;padding:16px;background:#fef3c7;border:2px solid #f59e0b;border-radius:14px;text-align:center;font-size:13px;line-height:1.8;color:#92400e}
.no-lib.show{display:block}
</style>
</head>
<body data-theme="light">

<div class="hdr">
  <div class="hdr-in">
    <div class="logo">
      <div class="logo-ico">ğŸ”</div>
      <div>
        <div class="logo-name">Aljorany</div>
        <div class="logo-sub">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Excel</div>
      </div>
    </div>
    <button class="ico-btn" onclick="toggleTheme()" id="themeBtn">ğŸŒ™</button>
  </div>
</div>

<div class="scroll">
<div class="content">

  <div class="no-lib" id="noLib">
    âš ï¸ <b>ÙŠÙ„Ø²Ù… ØªØ¶Ù…ÙŠÙ† Ù…ÙƒØªØ¨Ø© xlsx</b><br>
    Ø´ØºÙ‘Ù„ Ù…Ù„Ù <b>make-offline.ps1</b> Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©<br>
    Ø«Ù… Ø§Ø±ÙØ¹ index.html Ø¹Ù„Ù‰ GitHub
  </div>

  <div class="card">
    <div class="card-hd"><div class="card-ico">ğŸ“‚</div><div class="card-ttl">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel</div></div>
    <div class="card-bd">
      <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv" onchange="loadFile(this)">
      <div class="imp-zone" onclick="document.getElementById('fileInput').click()">
        <span class="imp-ico">ğŸ“Š</span>
        <div class="imp-txt">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù</div>
        <div class="imp-hint">xlsx Â· xls Â· xlsm Â· xlsb Â· xltx Â· xltm Â· ods Â· csv</div>
      </div>
      <div class="finfo" id="finfo">
        <div class="f-ico">ğŸ“—</div>
        <div class="f-det"><div class="f-nm" id="fNm">â€”</div><div class="f-mt" id="fMt">â€”</div></div>
        <div class="st-pill" id="fSt">Ø¬Ø§Ø±ÙŠ</div>
      </div>
      <div class="prog" id="prog">
        <div class="prog-lbs"><span id="pLbl">Ø¬Ø§Ø±ÙŠ...</span><span id="pPct">0%</span></div>
        <div class="prog-tr"><div class="prog-br" id="pBar"></div></div>
      </div>
    </div>
  </div>

  <div class="stats" id="stats">
    <div class="stat"><div class="stat-v" id="sRows">0</div><div class="stat-l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ</div></div>
    <div class="stat"><div class="stat-v" id="sShts">0</div><div class="stat-l">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</div></div>
    <div class="stat"><div class="stat-v" id="sRes">â€”</div><div class="stat-l">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div></div>
  </div>

  <div class="card">
    <div class="card-hd"><div class="card-ico">ğŸ”</div><div class="card-ttl">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div></div>
    <div class="card-bd">
      <div class="srch-row">
        <input class="srch-in" id="sIn" type="text" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù„Ø«..."
          oninput="onInp()" onkeydown="if(event.key==='Enter')doSearch()">
        <button class="srch-btn" id="sBtn" onclick="doSearch()" disabled>ğŸ”</button>
      </div>
      <div class="mode-row">ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø«: <span class="mpill" id="mPill">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚</span></div>
      <div class="fpanel" id="fpanel">
        <div>
          <div class="fsec-ttl">âš™ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø«</div>
          <div class="chips">
            <button class="chip active" id="mExact" onclick="setMode('exact')">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚</button>
            <button class="chip" id="mAny" onclick="setMode('any')">ğŸ”„ Ø£ÙŠ ØªØ±ØªÙŠØ¨</button>
            <button class="chip" id="mStart" onclick="setMode('start')">â–¶ï¸ ÙŠØ¨Ø¯Ø£ Ø¨Ù€</button>
          </div>
          <div class="mdesc" id="mDesc">ğŸ¯ <b>ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚:</b> ÙŠØ¨Ø­Ø« Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ø¨Ø§Ù„Ø¶Ø¨Ø· â€” Ø³ÙˆØ§Ø¡ ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø®Ù„Ø§ÙŠØ§ Ù…ØªØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØµÙ</div>
        </div>
        <div>
          <div class="fsec-ttl">ğŸ“„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ±Ù‚Ø©</div>
          <div class="chips" id="shChips"><button class="chip active" onclick="selSheet('__all__',this)">ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</button></div>
        </div>
      </div>
      <button class="ftog" onclick="togFilter()"><span id="fArr">â–¼</span><span id="fTxt">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©</span></button>
    </div>
  </div>

  <div class="card" id="resCard" style="display:none">
    <div class="res-hd">
      <div class="res-ttl">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ <span class="cnt-pill" id="cntP">0</span></div>
      <button class="copy-all" onclick="copyAll()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="res-list" id="resList"></div>
  </div>

  <div class="card" id="emptyCard">
    <div class="empty"><div class="e-ico">ğŸ“Š</div><div class="e-txt">Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù„Ù Excel<br>Ø«Ù… Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div></div>
  </div>

</div>
</div>
<div class="toast" id="toast"></div>

<script>
'use strict';

/* â”€â”€ ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙƒØªØ¨Ø© XLSX â”€â”€ */
window.addEventListener('load', () => {
  if (typeof XLSX === 'undefined') {
    document.getElementById('noLib').classList.add('show');
    document.getElementById('sBtn').disabled = true;
  }
});

/* â”€â”€ Ø§Ù„Ø­Ø§Ù„Ø© â”€â”€ */
let SHEETS=[], TOTAL=0, DARK=false, MODE='exact', ACTIVE='__all__';

function toggleTheme(){DARK=!DARK;document.body.setAttribute('data-theme',DARK?'dark':'light');document.getElementById('themeBtn').textContent=DARK?'â˜€ï¸':'ğŸŒ™';}

let _tt;
function toast(msg,ms=2500){clearTimeout(_tt);const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');_tt=setTimeout(()=>el.classList.remove('show'),ms);}

function fmtSz(b){return b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB';}
function setProg(p,l){document.getElementById('pBar').style.width=Math.min(p,100)+'%';document.getElementById('pPct').textContent=Math.round(p)+'%';if(l)document.getElementById('pLbl').textContent=l;}
const sleep=ms=>new Promise(r=>setTimeout(r,ms));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadFile(inp){
  if(typeof XLSX==='undefined'){toast('âŒ ÙŠÙ„Ø²Ù… ØªØ´ØºÙŠÙ„ make-offline.ps1 Ø£ÙˆÙ„Ø§Ù‹');return;}
  const file=inp.files[0];if(!file)return;
  SHEETS=[];TOTAL=0;ACTIVE='__all__';
  document.getElementById('resCard').style.display='none';
  document.getElementById('emptyCard').style.display='block';
  document.getElementById('stats').classList.remove('show');
  document.getElementById('sBtn').disabled=true;
  document.getElementById('sRes').textContent='â€”';
  document.getElementById('finfo').classList.add('show');
  document.getElementById('fNm').textContent=file.name;
  document.getElementById('fMt').textContent=fmtSz(file.size)+' â€¢ '+new Date(file.lastModified).toLocaleDateString('ar');
  document.getElementById('fSt').textContent='ÙŠÙØ­Ù…ÙÙ‘Ù„';
  document.getElementById('prog').classList.add('show');
  setProg(5,'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...');

  const reader=new FileReader();
  reader.onprogress=e=>{if(e.lengthComputable)setProg((e.loaded/e.total)*40,'ØªØ­Ù…ÙŠÙ„...');};
  reader.onload=async e=>{
    try{
      setProg(50,'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');await sleep(30);
      const raw=new Uint8Array(e.target.result);
      let wb;
      try{wb=XLSX.read(raw,{type:'array',cellText:true,cellDates:true,dense:true});}
      catch(_){wb=XLSX.read(new TextDecoder('utf-8',{fatal:false}).decode(raw),{type:'string'});}
      const names=wb.SheetNames;
      setProg(65,'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚...');await sleep(30);
      for(let i=0;i<names.length;i++){
        const ws=wb.Sheets[names[i]];
        const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:false});
        const rows=[];
        for(const row of json){
          const cr=row.map(c=>c!=null?String(c).trim():'');
          if(cr.some(c=>c!=='')){rows.push(cr);TOTAL++;}
        }
        SHEETS.push({name:names[i],rows});
        setProg(65+((i+1)/names.length)*32,'ÙˆØ±Ù‚Ø©: '+names[i]);
        await sleep(15);
      }
      setProg(100,'Ø§ÙƒØªÙ…Ù„ âœ…');
      document.getElementById('fSt').textContent='âœ… Ø¬Ø§Ù‡Ø²';
      document.getElementById('sRows').textContent=TOTAL.toLocaleString('ar');
      document.getElementById('sShts').textContent=names.length.toLocaleString('ar');
      document.getElementById('stats').classList.add('show');
      document.getElementById('sBtn').disabled=false;
      buildChips(names);
      toast('âœ… '+file.name+' â€” '+TOTAL.toLocaleString('ar')+' ØµÙ');
      setTimeout(()=>document.getElementById('prog').classList.remove('show'),900);
    }catch(err){
      console.error(err);
      document.getElementById('fSt').textContent='âŒ Ø®Ø·Ø£';
      toast('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: '+err.message);
      document.getElementById('prog').classList.remove('show');
    }
  };
  reader.readAsArrayBuffer(file);
}

function buildChips(names){
  const w=document.getElementById('shChips');
  w.innerHTML='<button class="chip active" onclick="selSheet(\'__all__\',this)">ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</button>';
  names.forEach(n=>{const b=document.createElement('button');b.className='chip';b.textContent=n;b.onclick=()=>selSheet(n,b);w.appendChild(b);});
}

function selSheet(n,btn){
  ACTIVE=n;
  document.querySelectorAll('#shChips .chip').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

let fOpen=false;
function togFilter(){fOpen=!fOpen;document.getElementById('fpanel').classList.toggle('show',fOpen);document.getElementById('fArr').textContent=fOpen?'â–²':'â–¼';document.getElementById('fTxt').textContent=fOpen?'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª':'Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©';}

const MINFO={
  exact:{pill:'ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚',desc:'ğŸ¯ <b>ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚:</b> ÙŠØ¨Ø­Ø« Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ø¨Ø§Ù„Ø¶Ø¨Ø· â€” Ø³ÙˆØ§Ø¡ ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø®Ù„Ø§ÙŠØ§ Ù…ØªØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØµÙ'},
  any:{pill:'ğŸ”„ Ø£ÙŠ ØªØ±ØªÙŠØ¨',desc:'ğŸ”„ <b>Ø£ÙŠ ØªØ±ØªÙŠØ¨:</b> ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† ÙˆØ£ÙŠ ØªØ±ØªÙŠØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ'},
  start:{pill:'â–¶ï¸ ÙŠØ¨Ø¯Ø£ Ø¨Ù€',desc:'â–¶ï¸ <b>ÙŠØ¨Ø¯Ø£ Ø¨Ù€:</b> ÙŠØ¬Ù„Ø¨ Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆØªØ­ØªÙˆÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ'}
};

function setMode(m){
  MODE=m;
  ['exact','any','start'].forEach(x=>document.getElementById('m'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('active',x===m));
  document.getElementById('mPill').textContent=MINFO[m].pill;
  document.getElementById('mDesc').innerHTML=MINFO[m].desc;
}

function onInp(){document.getElementById('sBtn').disabled=SHEETS.length===0||!document.getElementById('sIn').value.trim();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function norm(t){
  return String(t)
    .replace(/[Ø£Ø¥Ø¢Ø§]/g,'Ø§')
    .replace(/Ø©/g,'Ù‡')
    .replace(/Ù‰/g,'ÙŠ')
    .replace(/[\u064B-\u065F\u0670]/g,'')
    .replace(/\s+/g,' ')
    .trim().toLowerCase();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚ â€” 3 Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ§Øª
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function matchRow(qw,row){
  const nr=row.map(c=>norm(c));

  /* â‘  ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© */
  for(let ci=0;ci<row.length;ci++){
    const nc=nr[ci];if(!nc)continue;
    if(cellMatch(qw,nc))return{matched:row[ci],ci};
  }

  /* â‘¡ Ø®Ù„Ø§ÙŠØ§ Ù…ØªØªØ§Ù„ÙŠØ© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ (exact/start) */
  if(MODE==='exact'||MODE==='start'){
    const ne=nr.map((nc,i)=>({nc,i})).filter(x=>x.nc.length>0);
    for(let si=0;si<=ne.length-qw.length;si++){
      let ok=true;
      for(let wi=0;wi<qw.length;wi++){
        if(!ne[si+wi].nc.includes(qw[wi])){ok=false;break;}
      }
      if(ok){
        const matched=ne.slice(si,si+qw.length).map(x=>row[x.i]).join(' ');
        return{matched,ci:ne[si].i};
      }
    }
  }

  /* â‘¢ Ø£ÙŠ ØªØ±ØªÙŠØ¨ Ø¹Ø¨Ø± Ø£ÙŠ Ø®Ù„Ø§ÙŠØ§ (any) */
  if(MODE==='any'){
    const ne=nr.map((nc,i)=>({nc,i})).filter(x=>x.nc.length>0);
    const used=new Set(),idxs=[];
    for(const w of qw){
      let found=false;
      for(const {nc,i} of ne){
        if(!used.has(i)&&nc.includes(w)){idxs.push(i);used.add(i);found=true;break;}
      }
      if(!found)return null;
    }
    return{matched:idxs.map(i=>row[i]).join(' '),ci:idxs[0]};
  }
  return null;
}

function cellMatch(qw,nc){
  if(MODE==='exact'){
    let p=0;
    for(const w of qw){const i=nc.indexOf(w,p);if(i===-1)return false;p=i+w.length;}
    return true;
  }
  if(MODE==='any')return qw.every(w=>nc.includes(w));
  if(MODE==='start')return nc.startsWith(qw[0])&&qw.slice(1).every(w=>nc.includes(w));
  return false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doSearch(){
  const raw=document.getElementById('sIn').value.trim();
  if(!raw||!SHEETS.length)return;
  const qw=raw.split(/\s+/).filter(w=>w.length>0).map(norm);
  if(!qw.length)return;

  const results=[];
  document.getElementById('emptyCard').style.display='none';
  document.getElementById('resCard').style.display='none';
  document.getElementById('prog').classList.add('show');
  setProg(0,'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...');
  await sleep(20);

  const targets=ACTIVE==='__all__'?SHEETS:SHEETS.filter(s=>s.name===ACTIVE);
  for(let si=0;si<targets.length;si++){
    for(const row of targets[si].rows){
      const r=matchRow(qw,row);
      if(r)results.push({name:r.matched,sheet:targets[si].name,row});
    }
    setProg(((si+1)/targets.length)*100,'Ø¨Ø­Ø« ÙÙŠ: '+targets[si].name);
    await sleep(10);
  }

  setProg(100,'Ø§ÙƒØªÙ…Ù„ âœ…');
  setTimeout(()=>document.getElementById('prog').classList.remove('show'),700);
  document.getElementById('sRes').textContent=results.length.toLocaleString('ar');
  render(results,raw.split(/\s+/).filter(w=>w.length>0));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(results,qw){
  const list=document.getElementById('resList');
  list.innerHTML='';
  document.getElementById('cntP').textContent=results.length;
  document.getElementById('resCard').style.display='block';
  if(!results.length){
    list.innerHTML='<div class="empty"><div class="e-ico">ğŸ”</div><div class="e-txt">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬<br>Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¡</div></div>';
    return;
  }
  const nq=qw.map(norm);
  results.forEach((r,i)=>{
    const cells=r.row.filter(c=>c&&c.trim()!=='');
    const cp=cells.join(' | ');
    const ch=cells.map(c=>{
      const isH=nq.some(w=>norm(c).includes(w));
      return '<span class="cell'+(isH?' hit':'')+'">'+esc(c)+'</span>';
    }).join('');
    const d=document.createElement('div');
    d.className='ritem';d.style.animationDelay=(i*30)+'ms';d.dataset.copy=cp;
    d.innerHTML=
      '<button class="cbtn" onclick="cpItem(this,event)">ğŸ“‹</button>'+
      '<div class="rname">'+hlName(r.name,qw)+'</div>'+
      '<div class="rtags"><span class="rtag">ğŸ“„ '+esc(r.sheet)+'</span><span class="rtag">#'+(i+1)+'</span></div>'+
      '<div class="rcells">'+ch+'</div>';
    list.appendChild(d);
  });
  setTimeout(()=>document.getElementById('resCard').scrollIntoView({behavior:'smooth',block:'start'}),80);
}

function hlName(txt,words){
  let r=esc(txt);
  words.forEach(w=>{if(!w)try{r=r.replace(new RegExp(eRe(esc(w)),'gi'),m=>'<mark>'+m+'</mark>');}catch(_){}}); 
  return r;
}
function eRe(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
function esc(t){return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

function cpItem(btn,e){
  e.stopPropagation();
  wClip(btn.closest('.ritem').dataset.copy);
  btn.textContent='âœ…';btn.classList.add('done');
  setTimeout(()=>{btn.textContent='ğŸ“‹';btn.classList.remove('done');},2000);
}
function copyAll(){
  const items=[...document.querySelectorAll('.ritem')];
  wClip(items.map((el,i)=>(i+1)+'. '+el.dataset.copy).join('\n\n'));
  toast('âœ… ØªÙ… Ù†Ø³Ø® '+items.length+' Ù†ØªÙŠØ¬Ø©');
}
function wClip(t){
  if(navigator.clipboard){navigator.clipboard.writeText(t).then(()=>toast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!')).catch(()=>fbClip(t));}
  else fbClip(t);
}
function fbClip(t){
  const ta=document.createElement('textarea');ta.value=t;ta.style.cssText='position:fixed;opacity:0;top:0;left:0';
  document.body.appendChild(ta);ta.focus();ta.select();
  try{document.execCommand('copy');toast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!');}catch(_){toast('âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®');}
  document.body.removeChild(ta);
}

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
