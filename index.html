<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#6c63ff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Aljorany">
<link rel="manifest" href="manifest.json">
<title>Aljorany - Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„ÙØ§Øª Excel</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#f0f4ff;--surface:#fff;--surface2:#f8f9ff;
  --primary:#6c63ff;--primary2:#a78bfa;--accent:#06b6d4;
  --text:#1e1b4b;--text2:#6b7280;--border:#e5e7eb;
  --shadow:rgba(108,99,255,.15);--card:#fff;
  --res-bg:#f5f3ff;--prog-bg:#e0e7ff;--ok:#10b981;
}
[data-theme="dark"]{
  --bg:#0f0f1a;--surface:#1a1a2e;--surface2:#16213e;
  --primary:#7c73ff;--primary2:#a78bfa;--accent:#22d3ee;
  --text:#e0e7ff;--text2:#9ca3af;--border:#2d2d4e;
  --shadow:rgba(124,115,255,.25);--card:#1e1e35;
  --res-bg:#1a1a35;--prog-bg:#1e1b4b;--ok:#34d399;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:all .3s}

.hdr{background:linear-gradient(135deg,#6c63ff,#a855f7,#06b6d4);padding:22px 18px 32px;position:relative;overflow:hidden}
.hdr::before{content:'';position:absolute;width:280px;height:280px;border-radius:50%;background:rgba(255,255,255,.08);top:-100px;right:-70px}
.hdr-top{display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1}
.app-name{font-size:30px;font-weight:900;color:#fff;letter-spacing:2px;text-shadow:0 2px 15px rgba(0,0,0,.3)}
.app-sub{font-size:12px;color:rgba(255,255,255,.85);margin-top:4px;position:relative;z-index:1}
.theme-btn{width:44px;height:44px;border-radius:50%;border:2px solid rgba(255,255,255,.4);background:rgba(255,255,255,.2);color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s;flex-shrink:0}
.theme-btn:active{transform:scale(.9)}

.main{padding:18px 14px 50px;max-width:640px;margin:0 auto}

.card{background:var(--card);border-radius:20px;padding:18px;margin-bottom:14px;box-shadow:0 4px 20px var(--shadow);border:1px solid var(--border);transition:all .3s}
.sec-lbl{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:11px;display:flex;align-items:center;gap:5px}

.imp-btn{width:100%;padding:18px;border-radius:14px;border:2.5px dashed var(--primary);background:linear-gradient(135deg,rgba(108,99,255,.06),rgba(167,139,250,.06));color:var(--primary);font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:9px;transition:all .3s}
.imp-btn:active{transform:scale(.98)}
#fileInput{display:none}
.fmt-hint{font-size:11px;color:var(--text2);text-align:center;margin-top:7px}

.file-info{display:none;align-items:center;gap:11px;padding:13px;background:var(--res-bg);border-radius:13px;border:1px solid var(--border);margin-top:11px}
.file-info.show{display:flex}
.f-ico{font-size:32px;flex-shrink:0}
.f-det{flex:1;min-width:0}
.f-name{font-weight:700;font-size:13px;word-break:break-all}
.f-meta{font-size:11px;color:var(--text2);margin-top:2px}
.s-badge{font-size:11px;font-weight:700;padding:4px 11px;border-radius:20px;background:linear-gradient(135deg,#6c63ff,#a855f7);color:#fff;white-space:nowrap;flex-shrink:0}

.prog-wrap{display:none;margin-top:13px}
.prog-wrap.show{display:block}
.prog-top{display:flex;justify-content:space-between;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px}
.prog-bg{height:11px;background:var(--prog-bg);border-radius:11px;overflow:hidden}
.prog-fill{height:100%;border-radius:11px;background:linear-gradient(90deg,#6c63ff,#a855f7,#06b6d4,#6c63ff);background-size:300% 100%;animation:gm 2s linear infinite;transition:width .4s ease;width:0%}
@keyframes gm{0%{background-position:0% 50%}100%{background-position:300% 50%}}

.stats{display:none;gap:10px;margin-bottom:14px}
.stats.show{display:flex}
.stat{flex:1;background:var(--card);border:1px solid var(--border);border-radius:13px;padding:11px 7px;text-align:center;box-shadow:0 2px 10px var(--shadow)}
.stat-n{font-size:22px;font-weight:900;background:linear-gradient(135deg,#6c63ff,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.stat-l{font-size:10px;color:var(--text2);margin-top:2px;font-weight:600}

.srch-row{display:flex;gap:9px;align-items:center}
.srch-in{flex:1;padding:14px 16px;border-radius:13px;border:2px solid var(--border);background:var(--surface2);color:var(--text);font-size:16px;outline:none;transition:all .3s;font-family:inherit;direction:rtl}
.srch-in:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(108,99,255,.12);background:var(--surface)}
.srch-in::placeholder{color:var(--text2)}
.srch-btn{width:52px;height:52px;border-radius:13px;border:none;background:linear-gradient(135deg,#6c63ff,#a855f7);color:#fff;font-size:21px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s;flex-shrink:0}
.srch-btn:active{transform:scale(.92)}
.srch-btn:disabled{opacity:.4;cursor:not-allowed}

/* FILTER */
.filter-bar{display:none;margin-top:13px;flex-direction:column;gap:12px;border-top:1px solid var(--border);padding-top:13px}
.filter-bar.show{display:flex}
.filter-title{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:7px}
.filter-row{display:flex;flex-wrap:wrap;gap:7px}
.fchip{padding:8px 15px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface2);color:var(--text2);font-size:12px;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit}
.fchip.active{background:linear-gradient(135deg,#6c63ff,#a855f7);color:#fff;border-color:transparent;box-shadow:0 3px 10px rgba(108,99,255,.35)}
.fchip:active{transform:scale(.95)}
.schip{padding:6px 12px;border-radius:20px;border:1.5px solid var(--border);background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.schip.active{background:var(--accent);color:#fff;border-color:transparent}

.mode-info{font-size:11px;color:var(--text2);text-align:center;margin-top:9px;padding:7px;background:var(--surface2);border-radius:9px;line-height:1.6}
.mbadge{display:inline-block;background:linear-gradient(135deg,#6c63ff,#a855f7);color:#fff;padding:2px 9px;border-radius:10px;font-weight:700;font-size:10px}

.tog-btn{width:100%;margin-top:11px;padding:10px;border-radius:11px;border:1.5px solid var(--border);background:var(--surface2);color:var(--primary);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:7px;font-family:inherit;transition:all .2s}
.tog-btn:active{transform:scale(.98)}

/* RESULTS */
.res-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:13px}
.res-title{font-size:14px;font-weight:800;display:flex;align-items:center;gap:7px}
.cnt-badge{background:linear-gradient(135deg,#6c63ff,#a855f7);color:#fff;font-size:11px;font-weight:700;padding:3px 11px;border-radius:20px}
.copy-all{padding:7px 14px;border-radius:9px;border:none;background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff;font-size:12px;font-weight:700;cursor:pointer;transition:all .2s}
.copy-all:active{transform:scale(.95)}

.res-list{display:flex;flex-direction:column;gap:11px}
.res-item{background:var(--res-bg);border:1.5px solid var(--border);border-right:5px solid var(--primary);border-radius:15px;padding:14px 14px 14px 48px;position:relative;animation:si .25s ease}
@keyframes si{from{opacity:0;transform:translateY(-7px)}to{opacity:1;transform:translateY(0)}}

.res-name{font-size:18px;font-weight:800;color:var(--text);margin-bottom:8px;line-height:1.5}
.res-name mark{background:linear-gradient(135deg,rgba(108,99,255,.25),rgba(168,85,247,.25));color:var(--primary);border-radius:4px;padding:0 3px;font-weight:900}

.res-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:9px}
.tag{font-size:10px;padding:2px 9px;border-radius:20px;background:rgba(108,99,255,.1);color:var(--primary2);font-weight:700}

/* ÙƒÙ„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø± */
.row-full{border-top:1px dashed var(--border);padding-top:9px;margin-top:4px;display:flex;flex-wrap:wrap;gap:5px}
.cell-box{padding:4px 10px;border-radius:8px;font-size:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);line-height:1.5;max-width:100%;word-break:break-word}
.cell-box.hit{background:linear-gradient(135deg,rgba(108,99,255,.18),rgba(168,85,247,.18));border-color:var(--primary);color:var(--primary);font-weight:700}

.copy-btn{position:absolute;top:13px;left:13px;width:32px;height:32px;border-radius:9px;border:none;background:rgba(108,99,255,.1);color:var(--primary);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.copy-btn.done{background:var(--ok);color:#fff}

.empty{text-align:center;padding:45px 15px;color:var(--text2)}
.empty .em{font-size:52px;margin-bottom:13px}
.empty p{font-size:14px;line-height:1.7}

.toast{position:fixed;bottom:26px;left:50%;transform:translateX(-50%) translateY(120px);background:#1e1e35;color:#fff;padding:12px 26px;border-radius:30px;font-size:13px;font-weight:600;transition:transform .35s cubic-bezier(.34,1.56,.64,1);z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,.45);white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:var(--primary);border-radius:10px}
</style>
</head>
<body data-theme="light">

<div class="hdr">
  <div class="hdr-top">
    <div>
      <div class="app-name">ğŸ” Aljorany</div>
      <div class="app-sub">Ø§Ù„Ø¬ÙˆØ±Ø§Ù†ÙŠ â€” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ù…Ù„ÙØ§Øª Excel</div>
    </div>
    <button class="theme-btn" id="themeBtn" onclick="toggleTheme()">ğŸŒ™</button>
  </div>
</div>

<div class="main">

  <!-- IMPORT -->
  <div class="card">
    <div class="sec-lbl">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel</div>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv" onchange="loadFile(this)">
    <button class="imp-btn" onclick="document.getElementById('fileInput').click()">
      <span style="font-size:24px">ğŸ“Š</span><span>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù</span>
    </button>
    <p class="fmt-hint">xlsx Â· xls Â· xlsm Â· xlsb Â· xltx Â· xltm Â· ods Â· csv</p>
    <div class="file-info" id="fileInfo">
      <div class="f-ico">ğŸ“—</div>
      <div class="f-det">
        <div class="f-name" id="fName">â€”</div>
        <div class="f-meta" id="fMeta">â€”</div>
      </div>
      <div class="s-badge" id="fStatus">Ø¬Ø§Ø±ÙŠ...</div>
    </div>
    <div class="prog-wrap" id="progWrap">
      <div class="prog-top"><span id="progLbl">Ø¬Ø§Ø±ÙŠ...</span><span id="progPct">0%</span></div>
      <div class="prog-bg"><div class="prog-fill" id="progFill"></div></div>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats" id="statsRow">
    <div class="stat"><div class="stat-n" id="sRows">0</div><div class="stat-l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ</div></div>
    <div class="stat"><div class="stat-n" id="sSheets">0</div><div class="stat-l">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</div></div>
    <div class="stat"><div class="stat-n" id="sRes">â€”</div><div class="stat-l">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div></div>
  </div>

  <!-- SEARCH -->
  <div class="card">
    <div class="sec-lbl">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>
    <div class="srch-row">
      <input class="srch-in" id="searchInput" type="text"
        placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù„Ø«..."
        oninput="onInput()" onkeydown="if(event.key==='Enter')doSearch()">
      <button class="srch-btn" id="searchBtn" onclick="doSearch()" disabled>ğŸ”</button>
    </div>

    <div class="mode-info">
      ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ: <span class="mbadge" id="modeBadge">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚</span>
    </div>

    <!-- FILTER PANEL -->
    <div class="filter-bar" id="filterBar">

      <div>
        <div class="filter-title">âš™ï¸ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø«</div>
        <div class="filter-row">
          <button class="fchip active" id="modeExact" onclick="setMode('exact')">ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚</button>
          <button class="fchip" id="modeAny"   onclick="setMode('any')"  >ğŸ”„ Ø£ÙŠ ØªØ±ØªÙŠØ¨</button>
          <button class="fchip" id="modeStart" onclick="setMode('start')">â–¶ï¸ ÙŠØ¨Ø¯Ø£ Ø¨Ù€</button>
        </div>
        <div style="font-size:11px;color:var(--text2);margin-top:8px;line-height:1.7" id="modeDesc">
          ğŸ¯ <b>ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚:</b> ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ø¨Ø§Ù„Ø¶Ø¨Ø· â€” Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø«Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«
        </div>
      </div>

      <div>
        <div class="filter-title">ğŸ“„ ÙÙ„ØªØ±Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</div>
        <div id="sheetFilter" style="display:flex;flex-wrap:wrap;gap:7px">
          <button class="schip active" onclick="toggleSheet('__all__',this)">Ø§Ù„ÙƒÙ„</button>
        </div>
      </div>

    </div>

    <button class="tog-btn" onclick="toggleFilter()">
      <span>âš™ï¸</span><span id="filterBtnTxt">Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©</span>
    </button>
  </div>

  <!-- RESULTS -->
  <div class="card" id="resCard" style="display:none">
    <div class="res-hdr">
      <div class="res-title">ğŸ“‹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ <span class="cnt-badge" id="cntBadge">0</span></div>
      <button class="copy-all" onclick="copyAll()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="res-list" id="resList"></div>
  </div>

  <!-- EMPTY -->
  <div class="card" id="emptyCard">
    <div class="empty">
      <div class="em">ğŸ“Š</div>
      <p>Ø§Ø³ØªÙˆØ±Ø¯ Ù…Ù„Ù Excel<br>Ø«Ù… Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</p>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
let sheets = [], totalRows = 0, isDark = false;
let searchMode = 'exact';
let activeSheets = new Set(['__all__']);

function toggleTheme(){
  isDark=!isDark;
  document.body.setAttribute('data-theme',isDark?'dark':'light');
  document.getElementById('themeBtn').textContent=isDark?'â˜€ï¸':'ğŸŒ™';
}

function toast(msg,ms=2800){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),ms);
}

function fmtSize(b){
  if(b<1024)return b+' B';
  if(b<1048576)return (b/1024).toFixed(1)+' KB';
  return (b/1048576).toFixed(1)+' MB';
}

function setProg(pct,lbl){
  document.getElementById('progFill').style.width=Math.min(pct,100)+'%';
  document.getElementById('progPct').textContent=Math.round(pct)+'%';
  if(lbl)document.getElementById('progLbl').textContent=lbl;
}

function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

// â”€â”€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFile(input){
  const file=input.files[0]; if(!file)return;
  sheets=[];totalRows=0;activeSheets=new Set(['__all__']);
  document.getElementById('resCard').style.display='none';
  document.getElementById('emptyCard').style.display='block';
  document.getElementById('statsRow').classList.remove('show');
  document.getElementById('searchBtn').disabled=true;
  document.getElementById('sRes').textContent='â€”';
  document.getElementById('fileInfo').classList.add('show');
  document.getElementById('fName').textContent=file.name;
  document.getElementById('fMeta').textContent=fmtSize(file.size)+' â€¢ '+new Date(file.lastModified).toLocaleDateString('ar-SA');
  document.getElementById('fStatus').textContent='ÙŠÙØ­Ù…ÙÙ‘Ù„...';
  document.getElementById('progWrap').classList.add('show');
  setProg(5,'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...');

  const reader=new FileReader();
  reader.onprogress=e=>{if(e.lengthComputable)setProg((e.loaded/e.total)*40,'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');};
  reader.onload=async e=>{
    try{
      setProg(45,'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');await sleep(40);
      const data=new Uint8Array(e.target.result);
      setProg(55,'ÙØªØ­ Ø§Ù„Ù…ØµÙ†Ù...');await sleep(40);
      let wb;
      try{wb=XLSX.read(data,{type:'array',cellText:true,cellDates:true});}
      catch(_){wb=XLSX.read(new TextDecoder('utf-8',{fatal:false}).decode(data),{type:'string'});}
      const names=wb.SheetNames;
      setProg(65,'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚...');await sleep(40);
      for(let i=0;i<names.length;i++){
        const ws=wb.Sheets[names[i]];
        const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:false});
        const rows=[];
        for(const row of json){
          if(row.some(c=>c!==null&&c!==undefined&&String(c).trim()!=='')){
            rows.push(row.map(c=>(c!==null&&c!==undefined?String(c).trim():'')));
            totalRows++;
          }
        }
        sheets.push({name:names[i],rows});
        setProg(65+((i+1)/names.length)*30,'ÙˆØ±Ù‚Ø©: '+names[i]);
        await sleep(20);
      }
      setProg(100,'Ø§ÙƒØªÙ…Ù„ âœ…');
      document.getElementById('fStatus').textContent='âœ… Ø¬Ø§Ù‡Ø²';
      document.getElementById('sRows').textContent=totalRows.toLocaleString('ar');
      document.getElementById('sSheets').textContent=names.length.toLocaleString('ar');
      document.getElementById('statsRow').classList.add('show');
      document.getElementById('searchBtn').disabled=false;
      buildSheetFilter(names);
      toast('âœ… '+file.name+' â€” '+totalRows.toLocaleString('ar')+' ØµÙ');
      setTimeout(()=>document.getElementById('progWrap').classList.remove('show'),900);
    }catch(err){
      console.error(err);
      document.getElementById('fStatus').textContent='âŒ Ø®Ø·Ø£';
      toast('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.');
      document.getElementById('progWrap').classList.remove('show');
    }
  };
  reader.readAsArrayBuffer(file);
}

// â”€â”€ ÙÙ„ØªØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSheetFilter(names){
  const wrap=document.getElementById('sheetFilter');
  wrap.innerHTML='<button class="schip active" onclick="toggleSheet(\'__all__\',this)">Ø§Ù„ÙƒÙ„</button>';
  names.forEach(n=>{
    const btn=document.createElement('button');
    btn.className='schip';btn.textContent=n;
    btn.onclick=()=>toggleSheet(n,btn);
    wrap.appendChild(btn);
  });
}

function toggleSheet(name,btn){
  if(name==='__all__'){
    activeSheets=new Set(['__all__']);
    document.querySelectorAll('.schip').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  }else{
    activeSheets.delete('__all__');
    document.querySelector('.schip').classList.remove('active');
    if(btn.classList.contains('active')){
      btn.classList.remove('active');activeSheets.delete(name);
      if(activeSheets.size===0){activeSheets.add('__all__');document.querySelector('.schip').classList.add('active');}
    }else{btn.classList.add('active');activeSheets.add(name);}
  }
}

// â”€â”€ ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙ„ØªØ± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleFilter(){
  const bar=document.getElementById('filterBar');
  const show=bar.classList.toggle('show');
  document.getElementById('filterBtnTxt').textContent=show?'Ø¥Ø®ÙØ§Ø¡ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©':'Ø¥Ø¸Ù‡Ø§Ø± Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©';
}

// â”€â”€ ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const modeLabels={
  exact:'ğŸ¯ ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚',
  any:'ğŸ”„ Ø£ÙŠ ØªØ±ØªÙŠØ¨',
  start:'â–¶ï¸ ÙŠØ¨Ø¯Ø£ Ø¨Ù€'
};
const modeDescs={
  exact:'ğŸ¯ <b>ØªØ±ØªÙŠØ¨ Ø¯Ù‚ÙŠÙ‚:</b> ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ Ø¨Ø§Ù„Ø¶Ø¨Ø· â€” Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø«Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«',
  any:'ğŸ”„ <b>Ø£ÙŠ ØªØ±ØªÙŠØ¨:</b> ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø¨Ø£ÙŠ ØªØ±ØªÙŠØ¨ ÙƒØ§Ù† ÙÙŠ Ø§Ù„Ø³Ø·Ø±',
  start:'â–¶ï¸ <b>ÙŠØ¨Ø¯Ø£ Ø¨Ù€:</b> ÙŠØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ÙƒØªÙˆØ¨'
};

function setMode(mode){
  searchMode=mode;
  ['exact','any','start'].forEach(m=>{
    document.getElementById('mode'+m.charAt(0).toUpperCase()+m.slice(1)).classList.toggle('active',m===mode);
  });
  document.getElementById('modeBadge').textContent=modeLabels[mode];
  document.getElementById('modeDesc').innerHTML=modeDescs[mode];
}

function onInput(){
  const v=document.getElementById('searchInput').value.trim();
  document.getElementById('searchBtn').disabled=sheets.length===0||v.length===0;
}

// â”€â”€ ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function norm(t){
  return t.replace(/[Ø£Ø¥Ø¢]/g,'Ø§').replace(/Ø©/g,'Ù‡').replace(/Ù‰/g,'ÙŠ').replace(/\s+/g,' ').trim().toLowerCase();
}

// â”€â”€ Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ØªØ¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
function matchRow(parts, row){
  const normParts = parts.map(norm);

  // â”€â”€ 1) Ø¨Ø­Ø« ÙÙŠ Ø®Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ØªØ­ØªÙˆÙŠ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹
  for(const cell of row){
    if(!cell) continue;
    const nc = norm(cell);

    if(searchMode === 'exact'){
      // Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ÙƒØªÙˆØ¨ ØªÙ…Ø§Ù…Ø§Ù‹ (Ø§Ù„Ø£ÙˆÙ„ Ø«Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ù… Ø§Ù„Ø«Ø§Ù„Ø«)
      let pos=0, ok=true;
      for(const p of normParts){
        const idx=nc.indexOf(p,pos);
        if(idx===-1){ok=false;break;}
        pos=idx+p.length;
      }
      if(ok) return cell;

    }else if(searchMode === 'any'){
      // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø£ÙŠ ØªØ±ØªÙŠØ¨
      if(normParts.every(p=>nc.includes(p))) return cell;

    }else if(searchMode === 'start'){
      // Ø§Ù„Ø®Ù„ÙŠØ© ØªØ¨Ø¯Ø£ Ø¨Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„ ÙˆØªØ­ØªÙˆÙŠ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
      if(nc.startsWith(normParts[0]) && normParts.slice(1).every(p=>nc.includes(p))) return cell;
    }
  }

  // â”€â”€ 2) Ø¨Ø­Ø« Ø¹Ø¨Ø± Ø®Ù„Ø§ÙŠØ§ Ù…ØªØ¹Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ (ÙƒÙ„ Ø¬Ø²Ø¡ ÙÙŠ Ø®Ù„ÙŠØ© Ù…Ù†ÙØµÙ„Ø©)
  if(searchMode === 'exact' || searchMode === 'start'){
    const nonEmpty = row.filter(c=>c&&c.trim()!=='');
    const normCells = nonEmpty.map(c=>norm(c));
    for(let ci=0; ci<=normCells.length-normParts.length; ci++){
      let match=true;
      for(let pi=0; pi<normParts.length; pi++){
        // ÙƒÙ„ Ø¬Ø²Ø¡ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
        if(!normCells[ci+pi].includes(normParts[pi])){match=false;break;}
      }
      if(match) return nonEmpty.slice(ci, ci+normParts.length).join(' ');
    }
  }

  // â”€â”€ 3) Ù„Ù„ÙˆØ¶Ø¹ "Ø£ÙŠ ØªØ±ØªÙŠØ¨" â€” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ ÙÙŠ Ø£ÙŠ Ø®Ù„Ø§ÙŠØ§ Ù…Ù† Ø§Ù„ØµÙ
  if(searchMode === 'any'){
    const nonEmpty = row.filter(c=>c&&c.trim()!=='');
    const normCells = nonEmpty.map(c=>norm(c));
    const matched = [];
    for(const p of normParts){
      const idx = normCells.findIndex(nc=>nc.includes(p));
      if(idx===-1){matched.length=0;break;}
      matched.push(nonEmpty[idx]);
    }
    if(matched.length===normParts.length) return matched.join(' ');
  }

  return null;
}

// â”€â”€ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSearch(){
  const query=document.getElementById('searchInput').value.trim();
  if(!query||sheets.length===0)return;

  const parts=query.split(/\s+/).filter(p=>p.length>0);
  if(parts.length===0)return;

  const results=[];
  document.getElementById('emptyCard').style.display='none';
  document.getElementById('resCard').style.display='none';
  document.getElementById('progWrap').classList.add('show');
  setProg(0,'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...');
  await sleep(30);

  const targets=activeSheets.has('__all__')?sheets:sheets.filter(s=>activeSheets.has(s.name));

  for(let si=0;si<targets.length;si++){
    const sheet=targets[si];
    for(const row of sheet.rows){
      const matched=matchRow(parts,row);
      if(matched){
        results.push({name:matched, sheet:sheet.name, row:row});
      }
    }
    setProg(((si+1)/targets.length)*100,'Ø¨Ø­Ø« ÙÙŠ: '+sheet.name);
    await sleep(15);
  }

  setProg(100,'Ø§ÙƒØªÙ…Ù„ âœ…');
  setTimeout(()=>document.getElementById('progWrap').classList.remove('show'),700);
  document.getElementById('sRes').textContent=results.length.toLocaleString('ar');
  renderResults(results,parts);
}

// â”€â”€ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(results,parts){
  const list=document.getElementById('resList');
  const card=document.getElementById('resCard');
  list.innerHTML='';
  document.getElementById('cntBadge').textContent=results.length;
  card.style.display='block';

  if(results.length===0){
    list.innerHTML=`<div class="empty"><div class="em">ğŸ”</div>
      <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬<br>Ø¬Ø±Ù‘Ø¨ ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</p></div>`;
    return;
  }

  const normParts=parts.map(norm);

  results.forEach((r,i)=>{
    // ÙƒØ§Ù…Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø·Ø± (Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª)
    const fullRow=r.row.filter(c=>c&&c.trim()!=='');
    const fullRowText=fullRow.join(' | ');

    // Ø¹Ø±Ø¶ ÙƒÙ„ Ø®Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø·Ø± Ù…Ø¹ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…ØªØ·Ø§Ø¨Ù‚Ø©
    const cellsHtml=fullRow.map(cell=>{
      const nc=norm(cell);
      const isHit=normParts.some(p=>nc.includes(p));
      return `<span class="cell-box ${isHit?'hit':''}">${esc(cell)}</span>`;
    }).join('');

    const div=document.createElement('div');
    div.className='res-item';
    div.dataset.copy=fullRowText;

    div.innerHTML=`
      <button class="copy-btn" onclick="copyItem(this,event)">ğŸ“‹</button>
      <div class="res-name">${hlName(r.name,parts)}</div>
      <div class="res-tags">
        <span class="tag">ğŸ“„ ${esc(r.sheet)}</span>
        <span class="tag"># ${i+1}</span>
      </div>
      <div class="row-full">${cellsHtml}</div>
    `;
    list.appendChild(div);
  });
}

// â”€â”€ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø§Ø³Ù… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function hlName(text,parts){
  let result=esc(text);
  parts.forEach(part=>{
    const escaped=esc(part);
    const re=new RegExp(escaped,'gi');
    result=result.replace(re,m=>`<mark>${m}</mark>`);
  });
  return result;
}

function esc(t){
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€ Ø§Ù„Ù†Ø³Ø® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyItem(btn,e){
  e.stopPropagation();
  writeClip(btn.closest('.res-item').dataset.copy);
  btn.textContent='âœ…';btn.classList.add('done');
  setTimeout(()=>{btn.textContent='ğŸ“‹';btn.classList.remove('done');},2200);
}

function copyAll(){
  const items=[...document.querySelectorAll('.res-item')];
  writeClip(items.map((el,i)=>`${i+1}. ${el.dataset.copy}`).join('\n\n'));
  toast('âœ… ØªÙ… Ù†Ø³Ø® '+items.length+' Ù†ØªÙŠØ¬Ø©');
}

function writeClip(text){
  if(navigator.clipboard){
    navigator.clipboard.writeText(text).then(()=>toast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!'));
  }else{
    const ta=document.createElement('textarea');
    ta.value=text;ta.style.cssText='position:fixed;opacity:0';
    document.body.appendChild(ta);ta.select();
    document.execCommand('copy');document.body.removeChild(ta);
    toast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!');
  }
}

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
