<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#6c63ff">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Aljorany">
<link rel="manifest" href="/manifest.json">
<title>Aljorany - Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù…Ù„ÙØ§Øª Excel</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #f0f4ff;
    --surface: #ffffff;
    --surface2: #f8f9ff;
    --primary: #6c63ff;
    --primary2: #a78bfa;
    --accent: #06b6d4;
    --text: #1e1b4b;
    --text2: #6b7280;
    --border: #e5e7eb;
    --shadow: rgba(108,99,255,0.15);
    --card-bg: #fff;
    --result-bg: #f5f3ff;
    --result-border: #6c63ff;
    --progress-bg: #e0e7ff;
    --success: #10b981;
  }
  [data-theme="dark"] {
    --bg: #0f0f1a;
    --surface: #1a1a2e;
    --surface2: #16213e;
    --primary: #7c73ff;
    --primary2: #a78bfa;
    --accent: #22d3ee;
    --text: #e0e7ff;
    --text2: #9ca3af;
    --border: #2d2d4e;
    --shadow: rgba(124,115,255,0.25);
    --card-bg: #1e1e35;
    --result-bg: #1a1a35;
    --result-border: #7c73ff;
    --progress-bg: #1e1b4b;
    --success: #34d399;
  }

  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    transition: all 0.3s ease;
    overflow-x: hidden;
  }

  /* ===== HEADER ===== */
  .header {
    background: linear-gradient(135deg, #6c63ff 0%, #a855f7 50%, #06b6d4 100%);
    padding: 24px 20px 35px;
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute;
    width: 300px; height: 300px;
    border-radius: 50%;
    background: rgba(255,255,255,0.08);
    top: -100px; right: -80px;
  }
  .header::after {
    content: '';
    position: absolute;
    width: 200px; height: 200px;
    border-radius: 50%;
    background: rgba(255,255,255,0.06);
    bottom: -80px; left: -60px;
  }
  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
    z-index: 1;
  }
  .app-name {
    font-size: 32px;
    font-weight: 900;
    color: white;
    text-shadow: 0 2px 15px rgba(0,0,0,0.3);
    letter-spacing: 2px;
  }
  .app-subtitle {
    font-size: 13px;
    color: rgba(255,255,255,0.85);
    margin-top: 4px;
    position: relative;
    z-index: 1;
  }
  .theme-btn {
    width: 46px; height: 46px;
    border-radius: 50%;
    border: 2px solid rgba(255,255,255,0.45);
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 22px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
    transition: all 0.3s;
    flex-shrink: 0;
  }
  .theme-btn:active { transform: scale(0.92); }

  /* ===== MAIN ===== */
  .main {
    padding: 20px 16px 40px;
    max-width: 640px;
    margin: 0 auto;
  }

  /* ===== CARD ===== */
  .card {
    background: var(--card-bg);
    border-radius: 22px;
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: 0 4px 24px var(--shadow);
    border: 1px solid var(--border);
    transition: all 0.3s;
  }

  .section-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text2);
    text-transform: uppercase;
    letter-spacing: 1.2px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ===== IMPORT BUTTON ===== */
  .import-btn {
    width: 100%;
    padding: 20px;
    border-radius: 16px;
    border: 2.5px dashed var(--primary);
    background: linear-gradient(135deg, rgba(108,99,255,0.06), rgba(167,139,250,0.06));
    color: var(--primary);
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.3s;
  }
  .import-btn:active {
    background: linear-gradient(135deg, rgba(108,99,255,0.18), rgba(167,139,250,0.18));
    transform: scale(0.98);
  }
  .import-btn .btn-icon { font-size: 26px; }
  #fileInput { display: none; }

  .formats-hint {
    font-size: 11px;
    color: var(--text2);
    text-align: center;
    margin-top: 8px;
    line-height: 1.6;
  }

  /* ===== FILE INFO ===== */
  .file-info {
    display: none;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--result-bg);
    border-radius: 14px;
    border: 1px solid var(--border);
    margin-top: 12px;
  }
  .file-info.show { display: flex; }
  .file-emoji { font-size: 34px; flex-shrink: 0; }
  .file-details { flex: 1; min-width: 0; }
  .file-name-text {
    font-weight: 700;
    font-size: 14px;
    word-break: break-all;
    color: var(--text);
  }
  .file-meta-text {
    font-size: 11px;
    color: var(--text2);
    margin-top: 3px;
  }
  .status-badge {
    font-size: 11px;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 20px;
    background: linear-gradient(135deg, #6c63ff, #a855f7);
    color: white;
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* ===== PROGRESS ===== */
  .progress-wrap { display: none; margin-top: 14px; }
  .progress-wrap.show { display: block; }
  .progress-top {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    font-weight: 600;
    color: var(--text2);
    margin-bottom: 7px;
  }
  .progress-bg {
    height: 12px;
    background: var(--progress-bg);
    border-radius: 12px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    border-radius: 12px;
    background: linear-gradient(90deg, #6c63ff, #a855f7, #06b6d4, #6c63ff);
    background-size: 300% 100%;
    animation: gradMove 2s linear infinite;
    transition: width 0.4s ease;
    width: 0%;
  }
  @keyframes gradMove {
    0% { background-position: 0% 50%; }
    100% { background-position: 300% 50%; }
  }

  /* ===== STATS ===== */
  .stats-row {
    display: none;
    gap: 10px;
    margin-bottom: 16px;
  }
  .stats-row.show { display: flex; }
  .stat-box {
    flex: 1;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 12px 8px;
    text-align: center;
    box-shadow: 0 2px 10px var(--shadow);
  }
  .stat-number {
    font-size: 24px;
    font-weight: 900;
    background: linear-gradient(135deg, #6c63ff, #a855f7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .stat-label { font-size: 11px; color: var(--text2); margin-top: 2px; font-weight: 600; }

  /* ===== SEARCH ===== */
  .search-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .search-input {
    flex: 1;
    padding: 15px 18px;
    border-radius: 14px;
    border: 2px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-size: 16px;
    outline: none;
    transition: all 0.3s;
    font-family: inherit;
    direction: rtl;
  }
  .search-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(108,99,255,0.12);
    background: var(--surface);
  }
  .search-input::placeholder { color: var(--text2); }
  .search-btn {
    width: 54px; height: 54px;
    border-radius: 14px;
    border: none;
    background: linear-gradient(135deg, #6c63ff, #a855f7);
    color: white;
    font-size: 22px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.3s;
    flex-shrink: 0;
  }
  .search-btn:active { transform: scale(0.92); }
  .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .search-hint {
    font-size: 11px;
    color: var(--text2);
    text-align: center;
    margin-top: 8px;
  }

  /* ===== RESULTS HEADER ===== */
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }
  .results-title {
    font-size: 15px;
    font-weight: 800;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .count-badge {
    background: linear-gradient(135deg, #6c63ff, #a855f7);
    color: white;
    font-size: 12px;
    font-weight: 700;
    padding: 3px 12px;
    border-radius: 20px;
  }
  .copy-all-btn {
    padding: 8px 16px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, #10b981, #06b6d4);
    color: white;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .copy-all-btn:active { transform: scale(0.95); }

  /* ===== RESULT CARD ===== */
  .results-list { display: flex; flex-direction: column; gap: 12px; }

  .result-item {
    background: var(--result-bg);
    border: 1.5px solid var(--border);
    border-right: 5px solid var(--primary);
    border-radius: 16px;
    padding: 15px 16px 15px 50px;
    position: relative;
    animation: slideIn 0.25s ease;
    transition: all 0.2s;
  }
  .result-item:active { transform: scale(0.98); }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .result-main-name {
    font-size: 18px;
    font-weight: 800;
    color: var(--text);
    line-height: 1.4;
    margin-bottom: 8px;
  }
  .result-main-name mark {
    background: linear-gradient(135deg, rgba(108,99,255,0.22), rgba(168,85,247,0.22));
    color: var(--primary);
    border-radius: 4px;
    padding: 0 3px;
  }
  .result-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
  }
  .tag {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    background: rgba(108,99,255,0.1);
    color: var(--primary2);
    font-weight: 700;
  }
  .result-extra {
    font-size: 12px;
    color: var(--text2);
    line-height: 1.8;
    border-top: 1px solid var(--border);
    padding-top: 8px;
    margin-top: 4px;
  }
  .copy-item-btn {
    position: absolute;
    top: 14px;
    left: 14px;
    width: 34px; height: 34px;
    border-radius: 10px;
    border: none;
    background: rgba(108,99,255,0.1);
    color: var(--primary);
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .copy-item-btn.done { background: var(--success); color: white; }

  /* ===== EMPTY STATE ===== */
  .empty-box {
    text-align: center;
    padding: 50px 20px;
    color: var(--text2);
  }
  .empty-box .big-emoji { font-size: 56px; margin-bottom: 14px; }
  .empty-box p { font-size: 15px; line-height: 1.7; }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(120px);
    background: #1e1e35;
    color: white;
    padding: 13px 28px;
    border-radius: 30px;
    font-size: 14px;
    font-weight: 600;
    transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
    z-index: 9999;
    box-shadow: 0 8px 32px rgba(0,0,0,0.45);
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
</style>
</head>
<body data-theme="light">

<!-- HEADER -->
<div class="header">
  <div class="header-top">
    <div>
      <div class="app-name">ğŸ” Aljorany</div>
      <div class="app-subtitle">Ø§Ù„Ø¬ÙˆØ±Ø§Ù†ÙŠ â€” Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ ÙÙŠ Ù…Ù„ÙØ§Øª Excel</div>
    </div>
    <button class="theme-btn" id="themeBtn" onclick="toggleTheme()">ğŸŒ™</button>
  </div>
</div>

<div class="main">

  <!-- IMPORT CARD -->
  <div class="card">
    <div class="section-label">ğŸ“‚ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel</div>
    <input type="file" id="fileInput"
      accept=".xlsx,.xls,.xlsm,.xlsb,.xltx,.xltm,.ods,.csv"
      onchange="loadFile(this)">
    <button class="import-btn" onclick="document.getElementById('fileInput').click()">
      <span class="btn-icon">ğŸ“Š</span>
      <span>Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù</span>
    </button>
    <p class="formats-hint">
      ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯Ø§Øª: xlsx Â· xls Â· xlsm Â· xlsb Â· xltx Â· xltm Â· ods Â· csv
    </p>

    <!-- File Info -->
    <div class="file-info" id="fileInfo">
      <div class="file-emoji">ğŸ“—</div>
      <div class="file-details">
        <div class="file-name-text" id="fName">â€”</div>
        <div class="file-meta-text" id="fMeta">â€”</div>
      </div>
      <div class="status-badge" id="fStatus">Ø¬Ø§Ø±ÙŠ...</div>
    </div>

    <!-- Progress -->
    <div class="progress-wrap" id="progWrap">
      <div class="progress-top">
        <span id="progLabel">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>
        <span id="progPct">0%</span>
      </div>
      <div class="progress-bg">
        <div class="progress-fill" id="progFill"></div>
      </div>
    </div>
  </div>

  <!-- STATS ROW -->
  <div class="stats-row" id="statsRow">
    <div class="stat-box">
      <div class="stat-number" id="sRows">0</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="sSheets">0</div>
      <div class="stat-label">Ø§Ù„Ø£ÙˆØ±Ø§Ù‚</div>
    </div>
    <div class="stat-box">
      <div class="stat-number" id="sResults">â€”</div>
      <div class="stat-label">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
    </div>
  </div>

  <!-- SEARCH CARD -->
  <div class="card">
    <div class="section-label">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</div>
    <div class="search-row">
      <input class="search-input" id="searchInput" type="text"
        placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù‡Ù†Ø§..."
        oninput="onSearchInput()"
        onkeydown="if(event.key==='Enter') doSearch()">
      <button class="search-btn" id="searchBtn" onclick="doSearch()" disabled>ğŸ”</button>
    </div>
    <p class="search-hint">ÙŠØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ â€¢ ÙŠØ¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© ÙˆØ§Ù„Ø£ÙˆØ±Ø§Ù‚</p>
  </div>

  <!-- RESULTS CARD -->
  <div class="card" id="resultsCard" style="display:none;">
    <div class="results-header">
      <div class="results-title">
        ğŸ“‹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        <span class="count-badge" id="countBadge">0</span>
      </div>
      <button class="copy-all-btn" onclick="copyAll()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ÙƒÙ„</button>
    </div>
    <div class="results-list" id="resultsList"></div>
  </div>

  <!-- EMPTY STATE -->
  <div class="card" id="emptyCard">
    <div class="empty-box">
      <div class="big-emoji">ğŸ“Š</div>
      <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel<br>Ø«Ù… Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡</p>
    </div>
  </div>

</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sheets = [];      // [{name, rows:[[]]}]
let totalRows = 0;
let isDark = false;

// â”€â”€â”€ THEME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleTheme() {
  isDark = !isDark;
  document.body.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('themeBtn').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, ms = 2800) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), ms);
}

// â”€â”€â”€ FORMAT SIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

// â”€â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setProgress(pct, label) {
  document.getElementById('progFill').style.width = Math.min(pct, 100) + '%';
  document.getElementById('progPct').textContent = Math.round(pct) + '%';
  if (label) document.getElementById('progLabel').textContent = label;
}

// â”€â”€â”€ LOAD FILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadFile(input) {
  const file = input.files[0];
  if (!file) return;

  // Reset
  sheets = []; totalRows = 0;
  document.getElementById('resultsCard').style.display = 'none';
  document.getElementById('emptyCard').style.display = 'block';
  document.getElementById('statsRow').classList.remove('show');
  document.getElementById('searchBtn').disabled = true;
  document.getElementById('sResults').textContent = 'â€”';

  // Show file info
  document.getElementById('fileInfo').classList.add('show');
  document.getElementById('fName').textContent = file.name;
  document.getElementById('fMeta').textContent = fmtSize(file.size) + ' â€¢ ' + new Date(file.lastModified).toLocaleDateString('ar-SA');
  document.getElementById('fStatus').textContent = 'ÙŠÙØ­Ù…ÙÙ‘Ù„...';
  document.getElementById('progWrap').classList.add('show');
  setProgress(5, 'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...');

  const reader = new FileReader();

  reader.onprogress = (e) => {
    if (e.lengthComputable)
      setProgress((e.loaded / e.total) * 40, 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
  };

  reader.onload = async (e) => {
    try {
      setProgress(45, 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...');
      await sleep(40);

      const data = new Uint8Array(e.target.result);

      setProgress(55, 'ÙØªØ­ Ø§Ù„Ù…ØµÙ†Ù...');
      await sleep(40);

      let wb;
      try {
        wb = XLSX.read(data, { type: 'array', cellText: true, cellDates: true });
      } catch (_) {
        const txt = new TextDecoder('utf-8', { fatal: false }).decode(data);
        wb = XLSX.read(txt, { type: 'string' });
      }

      const sheetNames = wb.SheetNames;
      setProgress(65, 'Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ±Ø§Ù‚...');
      await sleep(40);

      for (let si = 0; si < sheetNames.length; si++) {
        const ws   = wb.Sheets[sheetNames[si]];
        const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: false });

        const validRows = [];
        for (const row of json) {
          const hasData = row.some(c => c !== null && c !== undefined && String(c).trim() !== '');
          if (hasData) {
            validRows.push(row.map(c => (c !== null && c !== undefined ? String(c).trim() : '')));
            totalRows++;
          }
        }
        sheets.push({ name: sheetNames[si], rows: validRows });

        const pct = 65 + ((si + 1) / sheetNames.length) * 30;
        setProgress(pct, 'ÙˆØ±Ù‚Ø©: ' + sheetNames[si]);
        await sleep(25);
      }

      setProgress(100, 'Ø§ÙƒØªÙ…Ù„ âœ…');
      document.getElementById('fStatus').textContent = 'âœ… Ø¬Ø§Ù‡Ø²';

      document.getElementById('sRows').textContent    = totalRows.toLocaleString('ar');
      document.getElementById('sSheets').textContent  = sheetNames.length.toLocaleString('ar');
      document.getElementById('statsRow').classList.add('show');
      document.getElementById('searchBtn').disabled = false;

      toast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + file.name + ' â€” ' + totalRows.toLocaleString('ar') + ' ØµÙ');
      setTimeout(() => document.getElementById('progWrap').classList.remove('show'), 900);

    } catch (err) {
      console.error(err);
      document.getElementById('fStatus').textContent = 'âŒ Ø®Ø·Ø£';
      toast('âŒ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ØªÙ†Ø³ÙŠÙ‚.');
      document.getElementById('progWrap').classList.remove('show');
    }
  };

  reader.onerror = () => {
    toast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.');
    document.getElementById('progWrap').classList.remove('show');
  };

  reader.readAsArrayBuffer(file);
}

// â”€â”€â”€ SLEEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€â”€ SEARCH INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onSearchInput() {
  const v = document.getElementById('searchInput').value.trim();
  document.getElementById('searchBtn').disabled = sheets.length === 0 || v.length === 0;
}

// â”€â”€â”€ NORMALIZE ARABIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function norm(t) {
  return t
    .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
    .replace(/Ø©/g, 'Ù‡')
    .replace(/Ù‰/g, 'ÙŠ')
    .replace(/\s+/g, ' ')
    .trim()
    .toLowerCase();
}

// â”€â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSearch() {
  const query = document.getElementById('searchInput').value.trim();
  if (!query || sheets.length === 0) return;

  const nq = norm(query);
  const results = [];

  document.getElementById('emptyCard').style.display = 'none';
  document.getElementById('resultsCard').style.display = 'none';
  document.getElementById('progWrap').classList.add('show');
  setProgress(0, 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...');

  await sleep(30);

  for (let si = 0; si < sheets.length; si++) {
    const sheet = sheets[si];
    for (const row of sheet.rows) {
      let matched = null;
      for (const cell of row) {
        if (!cell) continue;
        if (norm(cell).includes(nq)) { matched = cell; break; }
      }
      if (matched) {
        const others = row.filter(c => c && c !== matched).slice(0, 7);
        results.push({ name: matched, sheet: sheet.name, others });
      }
    }
    setProgress(((si + 1) / sheets.length) * 100, 'Ø¨Ø­Ø« ÙÙŠ: ' + sheet.name);
    await sleep(15);
  }

  setProgress(100, 'Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø¨Ø­Ø« âœ…');
  setTimeout(() => document.getElementById('progWrap').classList.remove('show'), 700);

  document.getElementById('sResults').textContent = results.length.toLocaleString('ar');
  renderResults(results, query);
}

// â”€â”€â”€ RENDER RESULTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(results, query) {
  const list  = document.getElementById('resultsList');
  const card  = document.getElementById('resultsCard');
  list.innerHTML = '';
  document.getElementById('countBadge').textContent = results.length;
  card.style.display = 'block';

  if (results.length === 0) {
    list.innerHTML = `
      <div class="empty-box">
        <div class="big-emoji">ğŸ”</div>
        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù†<br><strong>"${esc(query)}"</strong></p>
      </div>`;
    return;
  }

  results.forEach((r, i) => {
    const copyText = r.name + (r.others.length ? '\n' + r.others.join(' | ') : '');
    const extrasHtml = r.others.length
      ? `<div class="result-extra">${r.others.map(esc).join('  Â·  ')}</div>`
      : '';

    const div = document.createElement('div');
    div.className = 'result-item';
    div.dataset.copy = copyText;
    div.innerHTML = `
      <button class="copy-item-btn" onclick="copyItem(this,event)" title="Ù†Ø³Ø®">ğŸ“‹</button>
      <div class="result-main-name">${highlight(r.name, query)}</div>
      <div class="result-tags">
        <span class="tag">ğŸ“„ ${esc(r.sheet)}</span>
        <span class="tag"># ${i + 1}</span>
      </div>
      ${extrasHtml}
    `;
    list.appendChild(div);
  });
}

// â”€â”€â”€ HIGHLIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function highlight(text, query) {
  const ni = norm(text).indexOf(norm(query));
  if (ni === -1) return esc(text);
  return esc(text.slice(0, ni))
    + '<mark>' + esc(text.slice(ni, ni + query.length)) + '</mark>'
    + esc(text.slice(ni + query.length));
}

function esc(t) {
  return String(t)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â”€â”€â”€ COPY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function copyItem(btn, e) {
  e.stopPropagation();
  const text = btn.closest('.result-item').dataset.copy;
  writeClip(text);
  btn.textContent = 'âœ…';
  btn.classList.add('done');
  setTimeout(() => { btn.textContent = 'ğŸ“‹'; btn.classList.remove('done'); }, 2200);
}

function copyAll() {
  const items = [...document.querySelectorAll('.result-item')];
  const text  = items.map((el, i) => `${i+1}. ${el.dataset.copy}`).join('\n\n');
  writeClip(text);
  toast('âœ… ØªÙ… Ù†Ø³Ø® ' + items.length + ' Ù†ØªÙŠØ¬Ø©');
}

function writeClip(text) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => toast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!'));
  } else {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    toast('âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®!');
  }
}

// â”€â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  });
}
</script>
</body>
</html>
